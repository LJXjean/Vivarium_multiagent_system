<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vivarium Simulation</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container {
            max-width: 1000px;
            margin: 0 auto; /* Center the container */
            padding: 20px;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(10, 100px); /* 10x10 grid, each cell 100px */
            grid-gap: 2px;
            margin: 20px auto; /* Center the grid */
        }
        .grid-item {
            width: 100px;
            height: 100px;
            border: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }
        .form-section {
            margin: 20px 0;
        }
        label {
            font-weight: bold;
        }
        .organism {
            position: absolute;
            width: 100px; /* 根据您的网格大小调整 */
            height: 100px;
            transition: all 0.5s ease; /* 平滑动画效果 */
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="text-center my-4">Vivarium Simulation</h1>
    <h3>Current Time: <span id="hourDisplay">0</span> H</h3>
    <h3>Meteo: <span id="meteoDisplay">0</span></h3>
<!--    <h3>Current Climate Conditions</h3>-->
    <h3>Luminaire: <span id="luminaireDisplay">50</span>%</h3>
    <h3>Temperature: <span id="temperatureDisplay">20</span>℃</h3>
    <h3>Humidity: <span id="humidityDisplay">50.0</span>%</h3>
    <h3>CO2: <span id="co2Display">50.0</span>%</h3>
    <h3>O2: <span id="o2Display">20.95</span>%</h3>

    <div id="grid" class="grid-container"></div>

    <div class="row">
        <div class="col-md-4">
            <div class="form-section">
                <h3>Add Plant</h3>
                <!-- Form to add plants -->
                <form id="addPlantForm" class="form-group">
                    <div class="form-group">
                        <label for="plantType">Plant Type</label>
                        <select id="plantType" class="form-control">
                            <option value="PetitHerbe">PetitHerbe</option>
                            <option value="GrandHerbe">GrandHerbe</option>
                            <option value="Champignon">Champignon</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="plantPosX">Position X (0-9)</label>
                        <input type="number" id="plantPosX" class="form-control" min="0" max="9" required>
                    </div>
                    <div class="form-group">
                        <label for="plantPosY">Position Y (0-9)</label>
                        <input type="number" id="plantPosY" class="form-control" min="0" max="9" required>
                    </div>
                    <div class="form-group">
                        <label for="plantAge">Age</label>
                        <input type="number" id="plantAge" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="etatSante">Health Status</label>
                        <input type="number" id="etatSante" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="adaptabilite">Adaptability</label>
                        <input type="number" id="adaptabilite" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Plant</button>
                </form>
            </div>
        </div>

        <div class="col-md-4">
            <div class="form-section">
                <h3>Add Insect</h3>
                <!-- Form to add insects -->
                <form id="addInsectesForm" class="form-group">
                    <div class="form-group">
                        <label for="insecteType">Insect Type</label>
                        <select id="insecteType" class="form-control">
                            <option value="Escargot">Escargot</option>
                            <option value="Grillons">Grillons</option>
                            <option value="Lombric">Lombric</option>
                            <option value="PetitSerpent">PetitSerpent</option>
                            <option value="AraignéeSauteuse">AraignéeSauteuse</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="insectePosX">Position X (0-9)</label>
                        <input type="number" id="insectePosX" class="form-control" min="0" max="9" required>
                    </div>
                    <div class="form-group">
                        <label for="insectePosY">Position Y (0-9)</label>
                        <input type="number" id="insectePosY" class="form-control" min="0" max="9" required>
                    </div>
                    <div class="form-group">
                        <label for="insecteAge">Age</label>
                        <input type="number" id="insecteAge" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="vitesse">Speed</label>
                        <input type="number" id="vitesse" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="energy">Energy (0-10)</label>
                        <input type="number" id="energy" class="form-control" min="0" max="10" required>
                    </div>
                    <div class="form-group">
                        <label for="capaciteReproduction">Reproduction Capacity</label>
                        <input type="number" id="capaciteReproduction" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="niveauFaim">Hunger Level (0-10)</label>
                        <input type="number" id="niveauFaim" class="form-control" min="0" max="10" required>
                    </div>
                    <div class="form-group">
                        <label for="sexe">Sex</label>
                        <select id="sexe" class="form-control">
                            <option value="Male">Male</option>
                            <option value="Femelle">Femelle</option>
                            <option value="Hermaphrodite">Hermaphrodite</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="envieReproduire">Desire to Reproduce</label>
                        <select id="envieReproduire" class="form-control">
                            <option value="true">True</option>
                            <option value="false">False</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success">Add Insect</button>
                </form>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-section">
                <h3>Change Weather Conditions</h3>
                <select id="meteoType" class="form-control">
                    <option value="Pluie">Pluie</option>
                    <option value="Brouillard">Brouillard</option>
                    <option value="SaisonSeche">Saison Seche</option>
                    <option value="Incendie">Incendie</option>
                    <option value="Tonnerre">Tonnerre</option>
                    <option value="Rien">Rien</option>
                </select>
                </br>
                <button id="changeMeteo" class="btn btn-warning">Change Meteo</button>
            </div>
        </div>

<!--        <div class="col-md-3">-->
<!--            <div class="form-section">-->
<!--                <h3>Change Climate Conditions</h3>-->
<!--                <form id="changeClimatForm">-->
<!--                    <input type="number" id="inputLuminaire" placeholder="Luminaire (0-100)%" class="form-control">-->
<!--                    <input type="number" id="inputTemperature" placeholder="Temperature (-5-400)℃" class="form-control">-->
<!--                    <input type="number" id="inputHumidity" placeholder="Humidity (0-100)%" class="form-control">-->
<!--                    <input type="number" id="inputCO2" placeholder="CO2 (0-100)%" class="form-control">-->
<!--                    <input type="number" id="inputO2" placeholder="O2 (0-100)%" class="form-control">-->
<!--                    </br>-->
<!--                    <button type="submit" class="btn btn-primary">Update Climate</button>-->
<!--                </form>-->
<!--            </div>-->
<!--        </div>-->
    </div>

    <script type="text/javascript">
        var socket = new WebSocket("ws://localhost:8000/ws");

        // 在前端定义与后端 Go 枚举相对应的数组
        var meteoNames = ["Pluie", "Brouillard", "Saison Seche", "Incendie", "Tonnerre", "Rien"];

        // 设置定时器，例如每5秒钟请求一次最新数据
        setInterval(function() {
            // 发送请求更新的消息到服务器
            var requestTerrainData = {
                type: 'requestTerrainData',
            };
            socket.send(JSON.stringify(requestTerrainData));
        }, 100); // 100毫秒，即0.1秒

        socket.onmessage = function(event) {
            console.log("Message received from server");
            var terrain = JSON.parse(event.data);
            console.log(terrain);

            // 更新显示当前时间的元素
            document.getElementById('hourDisplay').textContent = terrain.CurrentHour;

            // 更新显示当前Meteo的元素
            // 因为enmus是int，必须转换为对应的metro的名字
            var meteoValue = meteoNames[terrain.Meteo]
            document.getElementById('meteoDisplay').textContent = meteoValue;

            // 更新显示当前Climat的元素
            // 更新气候数据
            document.getElementById('luminaireDisplay').textContent = terrain.Luminaire;
            document.getElementById('temperatureDisplay').textContent = terrain.Temperature;
            document.getElementById('humidityDisplay').textContent = terrain.Humidite.toFixed(2);
            document.getElementById('co2Display').textContent = terrain.Co2.toFixed(2);
            document.getElementById('o2Display').textContent = terrain.O2.toFixed(2);

            updateGridWithTerrain(terrain);
        };

        function updateGridWithTerrain(terrain) {
            const gridContainer = document.getElementById('grid');
            gridContainer.innerHTML = '';

            for (let y = 0; y < terrain.Length; y++) {
                for (let x = 0; x < terrain.Width; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-item';
                    const cellInfoArray = terrain.Grid[y][x];

                    // 设置背景颜色
                    if (cellInfoArray.length > 0) {
                        // 生物数量越多，颜色越深
                        const colorIntensity = Math.min(cellInfoArray.length, 10) / 10; // Assume up to 10 creatures
                        cell.style.backgroundColor = `rgba(0, 128, 0, ${colorIntensity})`;
                    }

                    let cellInfoText = cellInfoArray.map(info => `ID: ${info.OrganismID}, Type: ${info.OrganismType}`).join('<br>');
                    cell.innerHTML = cellInfoText || 'Empty';
                    gridContainer.appendChild(cell);
                }
            }
        }

        function createGrid(width, height) {
            const gridContainer = document.getElementById('grid');
            gridContainer.innerHTML = ''; // Clear previous content

            for (let i = 0; i < width * height; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-item';
                gridContainer.appendChild(cell);
            }
        }

        createGrid(10, 10); // Create a 10x10 grid

        // 处理添加植物表单的提交
        document.getElementById('addPlantForm').addEventListener('submit', function(event) {
            event.preventDefault(); // 防止表单的默认提交行为

            // 获取表单中的值
            var plantType = document.getElementById('plantType').value;
            var posX = document.getElementById('plantPosX').value;
            var posY = document.getElementById('plantPosY').value;
            var age = document.getElementById('plantAge').value;
            var etatSante = document.getElementById('etatSante').value;
            var adaptabilite = document.getElementById('adaptabilite').value;

            if (posX < 0 || posX > 9 || posY < 0 || posY > 9) {
                alert('Position X and Y must be between 0 and 9');
                return;
            }

            // 构造要发送的对象
            var plantData = {
                type: 'plant',
                plantType: plantType,
                posX: posX,
                posY: posY,
                plantAge: age,
                etatSante: etatSante,
                adaptabilite: adaptabilite
            };

            // 使用 WebSocket 发送数据到服务器
            socket.send(JSON.stringify(plantData));
        });

        // 处理添加昆虫表单的提交
        document.getElementById('addInsectesForm').addEventListener('submit', function(event) {
            event.preventDefault(); // 防止表单的默认提交行为

            // 获取表单中的值
            var insecteType = document.getElementById('insecteType').value;
            var posX = document.getElementById('insectePosX').value;
            var posY = document.getElementById('insectePosY').value;
            var insecteAge = document.getElementById('insecteAge').value;
            var vitesse = document.getElementById('vitesse').value;
            var energy = document.getElementById('energy').value;
            var capaciteReproduction = document.getElementById('capaciteReproduction').value;
            var niveauFaim = document.getElementById('niveauFaim').value;
            var sexe = document.getElementById('sexe').value;
            var envieReproduire = document.getElementById('envieReproduire').value;

            if (posX < 0 || posX > 9 || posY < 0 || posY > 9 || energy < 0 || energy > 10 || niveauFaim < 0 || niveauFaim > 10) {
                alert('Position X and Y must be between 0 and 9, Energy and NiveauFaim must be between 0 and 10');
                return;
            }

            // 构造要发送的对象
            var insecteData = {
                type: 'insecte',
                insecteType: insecteType,
                posX: posX,
                posY: posY,
                insecteAge: insecteAge,
                vitesse: vitesse,
                energy: energy,
                capaciteReproduction: capaciteReproduction,
                niveauFaim: niveauFaim,
                sexe: sexe,
                envieReproduire: envieReproduire
            };

            // 使用 WebSocket 发送数据到服务器
            socket.send(JSON.stringify(insecteData));
        });

        // 获取性别选择和昆虫类型选择的元素
        var sexeSelect = document.getElementById('sexe');
        var insecteTypeSelect = document.getElementById('insecteType');

        // 定义函数来更新性别选择的选项
        function updateSexeOptions() {
            var insecteType = insecteTypeSelect.value;
            var options = '';

            // 如果是Escargot或者Lombric 只能选Hermaphrodite性别
            if (insecteType === 'Escargot' || insecteType === 'Lombric') {
                options = '<option value="Hermaphrodite">Hermaphrodite</option>';
            } else {
                // 如果是其他昆虫 不能选Hermaphrodite性别
                options = '<option value="Male">Male</option>' +
                    '<option value="Femelle">Femelle</option>';
            }

            sexeSelect.innerHTML = options;
        }

        // 监听昆虫类型选择下拉框的变化
        insecteTypeSelect.addEventListener('change', updateSexeOptions);

        // 初始化性别选择下拉框
        updateSexeOptions();

        // 处理改变Meteo的表单提交
        document.getElementById('changeMeteo').addEventListener('click', function() {
            var meteoType = document.getElementById('meteoType').value;
            var meteoData = {
                type: 'changeMeteo',
                meteoType: meteoType
            };
            socket.send(JSON.stringify(meteoData));
        });

        // 处理Climat参数更改表单的提交
        // document.getElementById('changeClimatForm').addEventListener('submit', function(event) {
        //     event.preventDefault();
        //     var humidite = parseFloat(document.getElementById('inputHumidity').value);
        //     var co2 = parseFloat(document.getElementById('inputCO2').value);
        //     var o2 = parseFloat(document.getElementById('inputO2').value);
        //     var climatData = {
        //         type: 'changeClimat',
        //         Luminaire: document.getElementById('inputLuminaire').value,
        //         Temperature: document.getElementById('inputTemperature').value,
        //         Humidite: humidite,
        //         Co2: co2,
        //         O2: o2
        //     };
        //     socket.send(JSON.stringify(climatData));
        // });


    </script>

</div>
</body>
</html>